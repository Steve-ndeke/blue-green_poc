
pipeline {
    agent any
    environment {
        GITHUB_TOKEN = credentials('PAT-jenkins')
        K8S_NAMESPACE = 'blue-green'
    }

    // parameters {
    //     // Define parameters for the build
    //     string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Tag of the Docker image to deploy')
    // }
    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', credentialsId: 'PAT-jenkins', url: 'https://github.com/Steve-ndeke/blue-green_poc'
            }
        }

        stage('Helm Upgrade or Install') {
            steps {
                script {
                    helmUpgradeOrInstall()
                }
            }
    }

    }



}


def helmUpgradeOrInstall() {
    def deploymentExists = sh(script: "helm list -n ${env.K8S_NAMESPACE} | grep ${env.HELM_RELEASE_NAME}", returnStatus: true) == 0

    if (deploymentExists) {
        echo "Deployment exists. Upgrading..."
        sh "helm upgrade ${env.HELM_RELEASE_NAME} ${env.CHART_PATH} -n ${env.K8S_NAMESPACE}"
    } else {
        echo "Deployment does not exist. Installing..."
        sh "helm install ${env.HELM_RELEASE_NAME} ${env.CHART_PATH} -n ${env.K8S_NAMESPACE} --create-namespace"
    }
}
